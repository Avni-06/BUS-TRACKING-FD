<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bus Tracker - Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="script.js"></script>
  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body class="dashboard-body">
  <!-- Language Selector -->
  <div class="language-selector">
    <select id="languageSelect">
      <option value="en">English</option>
      <option value="hi">हिंदी</option>
      <option value="pa">ਪੰਜਾਬੀ</option>
    </select>
  </div>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span data-translate="bus_tracker">Bus Tracker</span>
      </div>
      <nav class="sidebar-nav">
        <a href="#" onclick="showPage('dashboard')" class="active" data-translate="dashboard">
          <i class="fa-solid fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="#" onclick="showPage('tracking')" data-translate="live_tracking">
          <i class="fa-solid fa-map-marker-alt"></i> Live Tracking
        </a>
        <a href="#" onclick="showPage('alerts')" data-translate="alerts">
          <i class="fa-solid fa-bell"></i> Alerts & Notifications
        </a>
        <a href="lostandfound.html" data-translate="lost_found">
          <i class="fa-solid fa-search"></i> Lost & Found
        </a>
        <a href="#" onclick="showPage('emergency')" data-translate="emergency">
          <i class="fa-solid fa-exclamation-triangle"></i> Emergency Support
        </a>
        <a href="#" onclick="showPage('settings')" data-translate="settings">
          <i class="fa-solid fa-gear"></i> Settings
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Navbar -->
      <header class="navbar">
        <div class="header-left">
          <button class="menu-toggle" id="menuToggle" style="background: none; border: none; color: white; font-size: 18px; margin-right: 15px; cursor: pointer; display: none;">
            <i class="fas fa-bars"></i>
          </button>
          <h1 id="pageTitle" data-translate="dashboard">Dashboard</h1>
        </div>
        <div class="header-right">
          <span id="userName" style="margin-right: 15px; color: white;"></span>
          <button class="logout-btn" onclick="logout()" data-translate="logout">Log Out</button>
        </div>
      </header>

      <!-- Dashboard Content -->
      <div class="content-area">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
          <!-- Quick Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <i class="fas fa-bus"></i>
              <h3 id="nearbyBuses">8</h3>
              <p data-translate="nearby_buses">Nearby Buses</p>
            </div>
            <div class="stat-card">
              <i class="fas fa-clock"></i>
              <h3 id="avgWaitTime">5m</h3>
              <p data-translate="avg_wait">Avg Wait Time</p>
            </div>
            <div class="stat-card">
              <i class="fas fa-route"></i>
              <h3 id="totalRoutes">28</h3>
              <p data-translate="total_routes">Available Routes</p>
            </div>
            <div class="stat-card">
              <i class="fas fa-bell"></i>
              <h3 id="activeAlerts">2</h3>
              <p data-translate="active_alerts">Active Alerts</p>
            </div>
          </div>

          <!-- Route Finder -->
          <div class="route-finder">
            <h3 data-translate="find_routes" style="margin-bottom: 20px;">Find Your Route</h3>
            <div class="route-inputs">
              <div class="input-group-route">
                <label data-translate="from">From</label>
                <input type="text" id="fromLocation" data-translate-placeholder="enter_start" placeholder="Enter starting location">
              </div>
              <div class="input-group-route">
                <label data-translate="to">To</label>
                <input type="text" id="toLocation" data-translate-placeholder="enter_dest" placeholder="Enter destination">
              </div>
              <button class="search-route-btn" onclick="searchRoutes()" data-translate="search">
                <i class="fas fa-search"></i> Search
              </button>
            </div>
          </div>

          <!-- Map Container -->
          <div class="map-container">
            <div id="map"></div>
            <div class="heatmap-legend">
              <div class="legend-item">
                <div class="legend-color" style="background: #ffebee;"></div>
                <span data-translate="low_crowd">Low Crowd</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #ffcdd2;"></div>
                <span data-translate="medium_crowd">Medium Crowd</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #ef9a9a;"></div>
                <span data-translate="high_crowd">High Crowd</span>
              </div>
            </div>
          </div>

          <!-- Bus Results -->
          <div class="bus-results" id="busResults" style="display: none;">
            <h3 style="padding: 20px; border-bottom: 1px solid #e0e0e0;" data-translate="available_routes">Available Routes</h3>
            <div id="busResultsList">
              <!-- Bus results will be populated here -->
            </div>
          </div>
        </div>

        <!-- Live Tracking Page -->
        <div id="trackingPage" class="page">
          <div class="map-container" style="height: 70vh;">
            <div id="trackingMap"></div>
          </div>
          <div class="bus-results">
            <h3 style="padding: 20px; border-bottom: 1px solid #e0e0e0;" data-translate="live_buses">Live Bus Locations</h3>
            <div id="liveBusList">
              <!-- Live bus data will be populated here -->
            </div>
          </div>
        </div>

        <!-- Alerts Page -->
        <div id="alertsPage" class="page">
          <div class="form-card">
            <h2 data-translate="notifications">Notifications & Alerts</h2>
            <div class="items" id="alertsList">
              <!-- Alerts will be populated here -->
            </div>
          </div>
        </div>

        <!-- Emergency Page -->
        <div id="emergencyPage" class="page">
          <div class="form-card">
            <h2 data-translate="emergency_support">Emergency Support</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
              <button class="btn btn-danger" onclick="reportEmergency('medical')" style="padding: 20px; display: flex; flex-direction: column; align-items: center;">
                <i class="fas fa-ambulance" style="font-size: 30px; margin-bottom: 10px;"></i>
                <span data-translate="medical_emergency">Medical Emergency</span>
              </button>
              <button class="btn" style="background: #fd7e14; padding: 20px; display: flex; flex-direction: column; align-items: center;" onclick="reportEmergency('fire')">
                <i class="fas fa-fire" style="font-size: 30px; margin-bottom: 10px;"></i>
                <span data-translate="fire_emergency">Fire Emergency</span>
              </button>
              <button class="btn" style="background: #6f42c1; padding: 20px; display: flex; flex-direction: column; align-items: center;" onclick="reportEmergency('security')">
                <i class="fas fa-shield-alt" style="font-size: 30px; margin-bottom: 10px;"></i>
                <span data-translate="security_issue">Security Issue</span>
              </button>
              <button class="btn" style="background: #20c997; padding: 20px; display: flex; flex-direction: column; align-items: center;" onclick="reportEmergency('breakdown')">
                <i class="fas fa-tools" style="font-size: 30px; margin-bottom: 10px;"></i>
                <span data-translate="bus_breakdown">Bus Breakdown</span>
              </button>
            </div>
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
              <h4 data-translate="emergency_contacts">Emergency Contacts</h4>
              <div style="margin-top: 10px;">
                <p><strong data-translate="police">Police:</strong> 100</p>
                <p><strong data-translate="ambulance">Ambulance:</strong> 108</p>
                <p><strong data-translate="fire_dept">Fire Department:</strong> 101</p>
                <p><strong data-translate="bus_helpline">Bus Helpline:</strong> 1800-XXX-XXXX</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
          <div class="form-card">
            <h2 data-translate="user_settings">User Settings</h2>
            <div class="form-group">
              <label data-translate="notification_preferences">Notification Preferences</label>
              <div style="margin-top: 10px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px;">
                  <input type="checkbox" id="busArrivalNotif" checked style="margin-right: 10px;">
                  <span data-translate="bus_arrival_notifications">Bus arrival notifications</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 10px;">
                  <input type="checkbox" id="routeChangeNotif" checked style="margin-right: 10px;">
                  <span data-translate="route_change_alerts">Route change alerts</span>
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" id="hapticFeedback" style="margin-right: 10px;">
                  <span data-translate="haptic_feedback">Haptic feedback alerts</span>
                </label>
              </div>
            </div>
            <div class="form-group">
              <label data-translate="preferred_routes">Preferred Routes</label>
              <input type="text" id="preferredRoutes" placeholder="e.g., 105, 120, 89" style="margin-top: 10px;">
            </div>
            <div class="form-group">
              <label data-translate="home_location">Home Location</label>
              <input type="text" id="homeLocation" placeholder="Enter your home address" style="margin-top: 10px;">
            </div>
            <div class="form-group">
              <label data-translate="work_location">Work Location</label>
              <input type="text" id="workLocation" placeholder="Enter your work address" style="margin-top: 10px;">
            </div>
            <button class="submit-btn" onclick="saveSettings()" data-translate="save_settings">Save Settings</button>
          </div>
        </div>
      </div>
    </main>

    <!-- Voice Assistant Button -->
    <button id="voice-btn" class="voice-button-admin" onclick="toggleVoiceAssistant()" style="left: 20px;">
      <i class="fa-solid fa-microphone"></i>
    </button>
  </div>

  <!-- Voice Assistant Modal -->
  <div id="voiceModal" class="voice-modal">
    <div class="voice-modal-content">
      <div class="voice-modal-header">
        <h3 data-translate="voice_assistant">Voice Assistant</h3>
        <span class="close" onclick="closeVoiceModal()">&times;</span>
      </div>
      <div class="voice-modal-body">
        <div id="voiceStatus" class="voice-status">
          <i class="fa-solid fa-microphone"></i>
          <p data-translate="click_speak">Click and speak...</p>
        </div>
        <div id="voiceResponse" class="voice-response"></div>
      </div>
    </div>
  </div>

  <script>
    let map, trackingMap;
    let currentUser = null;
    let buses = [];
    let currentPage = 'dashboard';

    // Language translations
    const translations = {
      en: {
        bus_tracker: "Bus Tracker",
        dashboard: "Dashboard",
        live_tracking: "Live Tracking",
        alerts: "Alerts & Notifications",
        lost_found: "Lost & Found",
        emergency: "Emergency Support",
        settings: "Settings",
        logout: "Log Out",
        nearby_buses: "Nearby Buses",
        avg_wait: "Avg Wait Time",
        total_routes: "Available Routes",
        active_alerts: "Active Alerts",
        find_routes: "Find Your Route",
        from: "From",
        to: "To",
        search: "Search",
        enter_start: "Enter starting location",
        enter_dest: "Enter destination",
        low_crowd: "Low Crowd",
        medium_crowd: "Medium Crowd",
        high_crowd: "High Crowd",
        available_routes: "Available Routes",
        live_buses: "Live Bus Locations",
        notifications: "Notifications & Alerts",
        emergency_support: "Emergency Support",
        medical_emergency: "Medical Emergency",
        fire_emergency: "Fire Emergency",
        security_issue: "Security Issue",
        bus_breakdown: "Bus Breakdown",
        emergency_contacts: "Emergency Contacts",
        police: "Police",
        ambulance: "Ambulance",
        fire_dept: "Fire Department",
        bus_helpline: "Bus Helpline",
        user_settings: "User Settings",
        notification_preferences: "Notification Preferences",
        bus_arrival_notifications: "Bus arrival notifications",
        route_change_alerts: "Route change alerts",
        haptic_feedback: "Haptic feedback alerts",
        preferred_routes: "Preferred Routes",
        home_location: "Home Location",
        work_location: "Work Location",
        save_settings: "Save Settings",
        voice_assistant: "Voice Assistant",
        click_speak: "Click and speak..."
      },
      hi: {
        bus_tracker: "बस ट्रैकर",
        dashboard: "डैशबोर्ड",
        live_tracking: "लाइव ट्रैकिंग",
        alerts: "अलर्ट और सूचनाएं",
        lost_found: "खोया और मिला",
        emergency: "आपातकालीन सहायता",
        settings: "सेटिंग्स",
        logout: "लॉग आउट",
        nearby_buses: "नजदीकी बसें",
        avg_wait: "औसत प्रतीक्षा समय",
        total_routes: "उपलब्ध रूट",
        active_alerts: "सक्रिय अलर्ट",
        find_routes: "अपना रूट खोजें",
        from: "से",
        to: "तक",
        search: "खोजें",
        voice_assistant: "वॉयस असिस्टेंट",
        click_speak: "क्लिक करें और बोलें..."
      },
      pa: {
        bus_tracker: "ਬੱਸ ਟਰੈਕਰ",
        dashboard: "ਡੈਸ਼ਬੋਰਡ",
        live_tracking: "ਲਾਈਵ ਟਰੈਕਿੰਗ",
        alerts: "ਚੇਤਾਵਨੀਆਂ ਅਤੇ ਸੂਚਨਾਵਾਂ",
        lost_found: "ਗੁਆਚਿਆ ਅਤੇ ਮਿਲਿਆ",
        emergency: "ਐਮਰਜੈਂਸੀ ਸਹਾਇਤਾ",
        settings: "ਸੈਟਿੰਗਜ਼",
        logout: "ਲੌਗ ਆਉਟ",
        voice_assistant: "ਵੌਇਸ ਸਹਾਇਕ",
        click_speak: "ਕਲਿੱਕ ਕਰੋ ਅਤੇ ਬੋਲੋ..."
      }
    };

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthStatus();
      initializeLanguage();
      initializeMaps();
      loadMockData();
      setupEventListeners();
    });

    function checkAuthStatus() {
      const savedUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      if (!savedUser || savedUser.type !== 'commuter') {
        window.location.href = 'login.html';
        return;
      }
      currentUser = savedUser;
      document.getElementById('userName').textContent = currentUser.name;
    }

    function initializeLanguage() {
      const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
      document.getElementById('languageSelect').value = savedLanguage;
      changeLanguage(savedLanguage);

      document.getElementById('languageSelect').addEventListener('change', function() {
        changeLanguage(this.value);
      });
    }

    function changeLanguage(lang) {
      const elements = document.querySelectorAll('[data-translate]');
      elements.forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[lang] && translations[lang][key]) {
          element.textContent = translations[lang][key];
        }
      });

      const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
      placeholderElements.forEach(element => {
        const key = element.getAttribute('data-translate-placeholder');
        if (translations[lang] && translations[lang][key]) {
          element.placeholder = translations[lang][key];
        }
      });

      localStorage.setItem('selectedLanguage', lang);
    }

    function setupEventListeners() {
      document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
    }

    function initializeMaps() {
      // Main dashboard map
      if (document.getElementById('map')) {
        map = L.map('map').setView([28.6139, 77.2090], 12);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        addSampleBuses();
      }

      // Get user location if available
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          if (map) {
            map.setView([lat, lng], 14);
            L.marker([lat, lng]).addTo(map)
              .bindPopup('Your current location')
              .openPopup();
          }
        });
      }
    }

    function initializeTrackingMap() {
      if (!trackingMap && document.getElementById('trackingMap')) {
        trackingMap = L.map('trackingMap').setView([28.6139, 77.2090], 12);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(trackingMap);
        
        addSampleBuses(trackingMap);
        updateLiveBusList();
      }
    }

    function addSampleBuses(mapInstance = map) {
      const sampleBuses = [
        { id: 'B001', route: '105', lat: 28.6139, lng: 77.2090, passengers: 45, capacity: 60, eta: '5 min' },
        { id: 'B002', route: '120', lat: 28.6289, lng: 77.2065, passengers: 38, capacity: 50, eta: '12 min' },
        { id: 'B003', route: '89', lat: 28.6089, lng: 77.2190, passengers: 52, capacity: 60, eta: '8 min' },
        { id: 'B004', route: '205', lat: 28.6189, lng: 77.1990, passengers: 25, capacity: 45, eta: '15 min' },
        { id: 'B005', route: '78', lat: 28.6339, lng: 77.2140, passengers: 30, capacity: 55, eta: '3 min' }
      ];

      sampleBuses.forEach(bus => {
        const crowdLevel = bus.passengers / bus.capacity;
        let color = '#ffebee'; // Light red for low crowd
        if (crowdLevel > 0.7) color = '#ef9a9a'; // Darker red for high crowd
        else if (crowdLevel > 0.5) color = '#ffcdd2'; // Medium red for medium crowd

        const marker = L.circleMarker([bus.lat, bus.lng], {
          radius: 10,
          fillColor: color,
          color: '#c62828',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(mapInstance);

        marker.bindPopup(`
          <div style="text-align: center;">
            <strong>🚌 Bus ${bus.route}</strong><br>
            <strong>ID:</strong> ${bus.id}<br>
            <strong>Passengers:</strong> ${bus.passengers}/${bus.capacity}<br>
            <strong>ETA:</strong> ${bus.eta}<br>
            <strong>Status:</strong> <span style="color: green;">Active</span>
          </div>
        `);
      });

      buses = sampleBuses;
    }

    function loadMockData() {
      // Update dashboard stats
      updateDashboardStats();
      loadAlertsList();
    }

    function updateDashboardStats() {
      // Simulate real-time updates
      setInterval(() => {
        document.getElementById('nearbyBuses').textContent = Math.floor(Math.random() * 5) + 6;
        document.getElementById('avgWaitTime').textContent = Math.floor(Math.random() * 8) + 3 + 'm';
        document.getElementById('activeAlerts').textContent = Math.floor(Math.random() * 4) + 1;
      }, 15000);
    }

    function loadAlertsList() {
      const mockAlerts = [
        { id: 1, title: 'Route 105 - 10 min delay due to traffic', type: 'warning', time: '5 min ago' },
        { id: 2, title: 'Route 120 - Service resumed normally', type: 'success', time: '15 min ago' },
        { id: 3, title: 'Heavy rain alert - Expect delays', type: 'info', time: '1 hour ago' },
        { id: 4, title: 'Route 89 - Temporary stop closure at Mall Road', type: 'warning', time: '2 hours ago' }
      ];

      const alertsHtml = mockAlerts.map(alert => `
        <div class="item">
          <div>
            <div class="item-title">${alert.title}</div>
            <div class="item-sub">${alert.time}</div>
          </div>
          <div class="status ${alert.type}" style="padding: 5px 10px; font-size: 12px;">
            ${alert.type.toUpperCase()}
          </div>
        </div>
      `).join('');

      if (document.getElementById('alertsList')) {
        document.getElementById('alertsList').innerHTML = alertsHtml;
      }
    }

    function showPage(page) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.sidebar-nav a').forEach(link => link.classList.remove('active'));
      
      // Show selected page
      const pageElement = document.getElementById(page + 'Page');
      if (pageElement) {
        pageElement.classList.add('active');
      }
      
      // Update active menu item
      event.target.classList.add('active');
      
      // Update page title
      const pageTitles = {
        'dashboard': translations[document.getElementById('languageSelect').value]?.dashboard || 'Dashboard',
        'tracking': translations[document.getElementById('languageSelect').value]?.live_tracking || 'Live Tracking',
        'alerts': translations[document.getElementById('languageSelect').value]?.alerts || 'Alerts & Notifications',
        'emergency': translations[document.getElementById('languageSelect').value]?.emergency || 'Emergency Support',
        'settings': translations[document.getElementById('languageSelect').value]?.settings || 'Settings'
      };
      document.getElementById('pageTitle').textContent = pageTitles[page] || 'Dashboard';
      
      currentPage = page;
      
      // Initialize page-specific content
      if (page === 'tracking') {
        setTimeout(initializeTrackingMap, 100);
      }
    }

    function searchRoutes() {
      const from = document.getElementById('fromLocation').value.trim();
      const to = document.getElementById('toLocation').value.trim();

      if (!from || !to) {
        alert('Please enter both starting location and destination');
        return;
      }

      // Show loading
      document.getElementById('busResults').style.display = 'block';
      document.getElementById('busResultsList').innerHTML = '<div style="padding: 20px; text-align: center;"><div class="loading"></div> Searching routes...</div>';

      // Sample stations for demonstration
      const sampleStations = [
        'ISBT Kashmere Gate', 'Red Fort', 'Chandni Chowk', 'New Delhi Railway Station',
        'Connaught Place', 'India Gate', 'Khan Market', 'Lajpat Nagar',
        'Nehru Place', 'Karol Bagh', 'Rajouri Garden', 'Janakpuri',
        'Dwarka', 'Gurgaon', 'Noida City Centre', 'Akshardham'
      ];

      // Simulate API call with realistic data
      setTimeout(() => {
        const mockResults = [
          { 
            route: '105', 
            from: from, 
            to: to, 
            eta: '12 min', 
            duration: '35 min', 
            crowd: 'low',
            stops: ['ISBT', 'Red Fort', 'Connaught Place', 'India Gate'],
            fare: '₹15'
          },
          { 
            route: '120', 
            from: from, 
            to: to, 
            eta: '8 min', 
            duration: '28 min', 
            crowd: 'medium',
            stops: ['Karol Bagh', 'Connaught Place', 'Khan Market', 'Lajpat Nagar'],
            fare: '₹12'
          },
          { 
            route: '89', 
            from: from, 
            to: to, 
            eta: '15 min', 
            duration: '42 min', 
            crowd: 'high',
            stops: ['Dwarka', 'Janakpuri', 'Karol Bagh', 'Connaught Place'],
            fare: '₹18'
          }
        ];

        displayBusResults(mockResults);
      }, 2000);
    }

    function displayBusResults(results) {
      const resultsHtml = results.map(bus => `
        <div class="bus-result-item" onclick="showRouteDetails('${bus.route}')" style="cursor: pointer;">
          <div class="bus-info">
            <h4>Route ${bus.route}</h4>
            <p>${bus.from} → ${bus.to}</p>
            <p><strong>Fare:</strong> ${bus.fare}</p>
            <span class="crowd-indicator crowd-${bus.crowd}">${bus.crowd.toUpperCase()} CROWD</span>
          </div>
          <div class="bus-timing">
            <div class="eta">${bus.eta}</div>
            <p>Journey: ${bus.duration}</p>
            <small>Click for route details</small>
          </div>
        </div>
      `).join('');

      document.getElementById('busResultsList').innerHTML = resultsHtml;
    }

    function showRouteDetails(routeNumber) {
      const routeInfo = {
        '105': {
          stops: ['ISBT Kashmere Gate', 'Red Fort', 'Chandni Chowk', 'New Delhi Station', 'Connaught Place', 'India Gate'],
          timings: ['6:00 AM', '6:15 AM', '6:30 AM', '6:45 AM', '7:00 AM', '7:15 AM'],
          frequency: 'Every 15 minutes'
        },
        '120': {
          stops: ['Karol Bagh', 'Patel Nagar', 'Connaught Place', 'Khan Market', 'Lodi Road', 'Lajpat Nagar'],
          timings: ['6:05 AM', '6:20 AM', '6:35 AM', '6:50 AM', '7:05 AM', '7:20 AM'],
          frequency: 'Every 12 minutes'
        },
        '89': {
          stops: ['Dwarka Sector 21', 'Janakpuri West', 'Tilak Nagar', 'Karol Bagh', 'Rajendra Place', 'Connaught Place'],
          timings: ['6:10 AM', '6:30 AM', '6:50 AM', '7:10 AM', '7:30 AM', '7:50 AM'],
          frequency: 'Every 20 minutes'
        }
      };

      const route = routeInfo[routeNumber];
      if (route) {
        alert(`Route ${routeNumber} Details:\n\nStops: ${route.stops.join(' → ')}\n\nFrequency: ${route.frequency}\n\nNext timings: ${route.timings.slice(0,3).join(', ')}`);
      }
    }

    function updateLiveBusList() {
      const liveBusesHtml = buses.map(bus => `
        <div class="bus-result-item">
          <div class="bus-info">
            <h4>Bus ${bus.route} (${bus.id})</h4>
            <p>Passengers: ${bus.passengers}/${bus.capacity}</p>
            <span class="crowd-indicator crowd-${bus.passengers/bus.capacity > 0.7 ? 'high' : bus.passengers/bus.capacity > 0.5 ? 'medium' : 'low'}">
              ${bus.passengers/bus.capacity > 0.7 ? 'HIGH' : bus.passengers/bus.capacity > 0.5 ? 'MEDIUM' : 'LOW'} CROWD
            </span>
          </div>
          <div class="bus-timing">
            <div class="eta">${bus.eta}</div>
            <p>Last update: Just now</p>
          </div>
        </div>
      `).join('');

      if (document.getElementById('liveBusList')) {
        document.getElementById('liveBusList').innerHTML = liveBusesHtml;
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('open');
    }

    function logout() {
      sessionStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    }

    function reportEmergency(type) {
      const emergencyTypes = {
        'medical': 'Medical Emergency',
        'fire': 'Fire Emergency',
        'security': 'Security Issue',
        'breakdown': 'Bus Breakdown'
      };

      const confirmed = confirm(`Are you sure you want to report a ${emergencyTypes[type]}?\n\nThis will alert emergency services and nearby authorities.`);
      
      if (confirmed) {
        alert(`${emergencyTypes[type]} reported successfully!\n\nEmergency ID: EMG${Date.now()}\nHelp is on the way.\n\nFor immediate assistance, call:\nPolice: 100\nAmbulance: 108\nFire: 101`);
        
        // Add to alerts list
        const alertsContainer = document.getElementById('alertsList');
        if (alertsContainer) {
          const newAlert = `
            <div class="item" style="background: #ffebee;">
              <div>
                <div class="item-title">${emergencyTypes[type]} reported</div>
                <div class="item-sub">Just now</div>
              </div>
              <div class="status" style="background: #f44336; color: white; padding: 5px 10px; font-size: 12px;">
                URGENT
              </div>
            </div>
          `;
          alertsContainer.insertAdjacentHTML('afterbegin', newAlert);
        }
      }
    }

    function saveSettings() {
      const settings = {
        busArrivalNotif: document.getElementById('busArrivalNotif').checked,
        routeChangeNotif: document.getElementById('routeChangeNotif').checked,
        hapticFeedback: document.getElementById('hapticFeedback').checked,
        preferredRoutes: document.getElementById('preferredRoutes').value,
        homeLocation: document.getElementById('homeLocation').value,
        workLocation: document.getElementById('workLocation').value
      };

      localStorage.setItem('userSettings', JSON.stringify(settings));
      alert('Settings saved successfully!');
    }

    // Load saved settings
    function loadSettings() {
      const savedSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
      
      if (savedSettings.busArrivalNotif !== undefined) {
        document.getElementById('busArrivalNotif').checked = savedSettings.busArrivalNotif;
      }
      if (savedSettings.routeChangeNotif !== undefined) {
        document.getElementById('routeChangeNotif').checked = savedSettings.routeChangeNotif;
      }
      if (savedSettings.hapticFeedback !== undefined) {
        document.getElementById('hapticFeedback').checked = savedSettings.hapticFeedback;
      }
      if (savedSettings.preferredRoutes) {
        document.getElementById('preferredRoutes').value = savedSettings.preferredRoutes;
      }
      if (savedSettings.homeLocation) {
        document.getElementById('homeLocation').value = savedSettings.homeLocation;
      }
      if (savedSettings.workLocation) {
        document.getElementById('workLocation').value = savedSettings.workLocation;
      }
    }

    // Voice Assistant Functions
    function toggleVoiceAssistant() {
      document.getElementById('voiceModal').style.display = 'block';
      startListening();
    }

    function closeVoiceModal() {
      document.getElementById('voiceModal').style.display = 'none';
      stopListening();
    }

    let recognition;
    let isListening = false;

    function startListening() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = document.getElementById('languageSelect').value === 'hi' ? 'hi-IN' : 
                         document.getElementById('languageSelect').value === 'pa' ? 'pa-IN' : 'en-US';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = function() {
          isListening = true;
          document.getElementById('voiceStatus').innerHTML = 
            '<i class="fa-solid fa-microphone-lines"></i><p>Listening...</p>';
        };

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          handleVoiceCommand(transcript);
        };

        recognition.onerror = function(event) {
          document.getElementById('voiceResponse').innerHTML = 
            '<p>Sorry, I couldn\'t understand. Please try again.</p>';
        };

        recognition.onend = function() {
          isListening = false;
          document.getElementById('voiceStatus').innerHTML = 
            '<i class="fa-solid fa-microphone"></i><p>Click and speak...</p>';
        };

        recognition.start();
      } else {
        document.getElementById('voiceResponse').innerHTML = 
          '<p>Voice recognition is not supported in your browser.</p>';
      }
    }

    function stopListening() {
      if (recognition && isListening) {
        recognition.stop();
      }
    }

    function handleVoiceCommand(command) {
      const lowerCommand = command.toLowerCase();
      let response = '';

      if (lowerCommand.includes('find') && (lowerCommand.includes('bus') || lowerCommand.includes('route'))) {
        response = 'Please use the search form to enter your starting location and destination, then I can help you find the best routes.';
      } else if (lowerCommand.includes('show') && lowerCommand.includes('tracking')) {
        showPage('tracking');
        response = 'Showing live bus tracking page.';
      } else if (lowerCommand.includes('show') && lowerCommand.includes('alerts')) {
        showPage('alerts');
        response = 'Showing alerts and notifications page.';
      } else if (lowerCommand.includes('emergency')) {
        showPage('emergency');
        response = 'Opening emergency support page. Please select the type of emergency you need help with.';
      } else if (lowerCommand.includes('settings')) {
        showPage('settings');
        response = 'Opening settings page where you can customize your preferences.';
      } else if (lowerCommand.includes('nearby') || lowerCommand.includes('near')) {
        response = `There are currently ${document.getElementById('nearbyBuses').textContent} buses nearby. The average wait time is ${document.getElementById('avgWaitTime').textContent}.`;
      } else if (lowerCommand.includes('home') || lowerCommand.includes('dashboard')) {
        showPage('dashboard');
        response = 'Showing main dashboard.';
      } else {
        response = 'I can help you with: finding bus routes, showing live tracking, checking alerts, emergency support, or settings. What would you like to do?';
      }

      document.getElementById('voiceResponse').innerHTML = `<p><strong>You said:</strong> "${command}"</p><p><strong>Response:</strong> ${response}</p>`;
    }

    // Simulate real-time bus updates
    setInterval(() => {
      if (buses.length > 0 && (map || trackingMap)) {
        buses.forEach((bus) => {
          // Slightly move buses to simulate movement
          bus.lat += (Math.random() - 0.5) * 0.001;
          bus.lng += (Math.random() - 0.5) * 0.001;
          
          // Update passenger count occasionally
          if (Math.random() < 0.1) {
            bus.passengers = Math.max(0, Math.min(bus.capacity, bus.passengers + Math.floor(Math.random() * 10) - 5));
          }

          // Update ETA
          const etas = ['2 min', '5 min', '8 min', '12 min', '15 min'];
          if (Math.random() < 0.2) {
            bus.eta = etas[Math.floor(Math.random() * etas.length)];
          }
        });
        
        updateLiveBusList();
      }
    }, 8000);

    // Responsive design
    window.addEventListener('resize', function() {
      if (window.innerWidth <= 768) {
        document.getElementById('menuToggle').style.display = 'block';
      } else {
        document.getElementById('menuToggle').style.display = 'none';
        document.getElementById('sidebar').classList.remove('open');
      }
      
      if (map) {
        setTimeout(() => map.invalidateSize(), 100);
      }
      if (trackingMap) {
        setTimeout(() => trackingMap.invalidateSize(), 100);
      }
    });

    // Load settings on page load
    setTimeout(loadSettings, 1000);

    // Initialize mobile check
    if (window.innerWidth <= 768) {
      document.getElementById('menuToggle').style.display = 'block';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const voiceModal = document.getElementById('voiceModal');
      if (event.target == voiceModal) {
        closeVoiceModal();
      }
    }
  </script>
</body>
</html>